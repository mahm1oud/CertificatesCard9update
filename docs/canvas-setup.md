# إعداد مكتبة Canvas للتوليد الجرافيكي

## ما هي مكتبة Canvas؟

مكتبة Canvas هي مكتبة JavaScript/TypeScript تستخدم لإنشاء وتوليد الرسومات والصور برمجياً. وهي أساسية في تطبيقنا لتوليد الشهادات والبطاقات التي يطلبها المستخدمون.

## مقارنة بين الاستخدام في بيئة التطوير وبيئة الإنتاج

### بيئة التطوير (Replit)

في بيئة التطوير، نستخدم نسخة وهمية (Mock) من مكتبة Canvas لتسهيل التطوير وتجنب تثبيت المكتبات الإضافية المعقدة. هذه النسخة الوهمية موجودة في الملف:

```
server/lib/canvas-mock.ts
```

تعمل هذه النسخة الوهمية بتسجيل العمليات في السجلات بدلاً من تنفيذها فعلياً، وتقوم بإنشاء صور بسيطة للاختبار.

### بيئة الإنتاج (Hostinger)

في بيئة الإنتاج، يجب استخدام النسخة الحقيقية من مكتبة Canvas لتوليد الصور بجودة عالية. لتثبيت المكتبة الحقيقية، يجب توفر مكتبات نظام إضافية مثل:

- cairo
- pango
- libpng
- libjpeg
- giflib
- librsvg

## خطوات التحويل لاستخدام المكتبة الحقيقية

### 1. تثبيت مكتبات النظام المطلوبة

قم بتشغيل السكربت التالي لتثبيت المكتبات المطلوبة:

```bash
sudo bash install/scripts/install-canvas-dependencies.sh
```

### 2. تثبيت مكتبة node-canvas وتحويل التطبيق لاستخدامها

قم بتشغيل السكربت التالي لتثبيت المكتبة وتعديل ملفات التطبيق:

```bash
node install/scripts/switch-to-real-canvas.js
```

### 3. إعادة تشغيل التطبيق

قم بإعادة تشغيل التطبيق لتفعيل التغييرات:

```bash
pm2 restart all
```

## استكشاف الأخطاء وإصلاحها

إذا واجهت مشاكل في توليد الصور في بيئة الإنتاج، يرجى التحقق من النقاط التالية:

1. **التأكد من تثبيت مكتبات النظام**: تحقق من تثبيت جميع المكتبات المطلوبة باستخدام:
   ```bash
   apt list --installed | grep -E 'cairo|pango|libpng|libjpeg|giflib|librsvg'
   ```

2. **التحقق من تثبيت المكتبة**: تأكد من وجود مكتبة canvas في قائمة node_modules:
   ```bash
   npm list canvas
   ```

3. **فحص سجلات الأخطاء**: يمكنك الاطلاع على سجلات الأخطاء في:
   ```bash
   pm2 logs
   ```

4. **الرجوع إلى النسخة الوهمية**: إذا استمرت المشاكل، يمكنك استعادة النسخة الوهمية مؤقتاً:
   ```bash
   mv server/lib/canvas-mock.ts.bak server/lib/canvas-mock.ts
   ```

## الفروق الرئيسية بين النسختين

| النسخة الوهمية | النسخة الحقيقية |
|--------------|---------------|
| لا تحتاج لمكتبات نظام | تحتاج لمكتبات نظام |
| صور بجودة منخفضة | صور بجودة عالية |
| تعمل في جميع البيئات | تحتاج لتهيئة خاصة |
| لا تدعم كل الميزات | دعم كامل لجميع الميزات |
| مناسبة للتطوير فقط | مناسبة للإنتاج |