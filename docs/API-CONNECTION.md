# دليل توصيل API بين الواجهة الأمامية والخلفية

## نظرة عامة

هذا الدليل يشرح كيفية تكوين الاتصال بين الواجهة الأمامية (Frontend) والخلفية (Backend) بحيث يعملان بسلاسة سواء في بيئة التطوير المحلية أو عند النشر على استضافة مثل Hostinger.

## المكونات الرئيسية

تتكون البنية التحتية للربط بين الواجهة الأمامية والخلفية من:

1. **تكوين API المركزي** (client/src/lib/api-config.ts)
2. **عميل الاستعلام** (client/src/lib/queryClient.ts)
3. **وسائط إعادة التوجيه** (server/lib/api-redirect.ts)
4. **متغيرات البيئة** (.env)

## كيفية الاستخدام

### في بيئة التطوير

في بيئة التطوير، يتم استخدام المسارات النسبية تلقائيًا:

```typescript
// سيتم تحويل هذا المسار تلقائيًا إلى المسار المناسب في بيئة التطوير
import { apiRequest } from '@/lib/queryClient';

const data = await apiRequest('/api/templates');
```

### في بيئة الإنتاج

في بيئة الإنتاج، يتم استخدام عنوان API المطلق المحدد في متغيرات البيئة:

```bash
# في ملف .env
API_URL=https://collider.online
```

وسيتم تحويل جميع الطلبات تلقائيًا إلى هذا العنوان.

## تغيير عنوان API

لتغيير عنوان API:

1. **تعديل متغير البيئة**:
   ```bash
   API_URL=https://your-new-domain.com
   ```

2. **استخدام سكريبت الإعداد**:
   ```bash
   node install/scripts/setup-prod-env.js
   ```
   ثم اتبع التعليمات لإدخال عنوان API الجديد.

## كيف يعمل

### 1. تكوين API المركزي

ملف `client/src/lib/api-config.ts` يقوم بما يلي:

- تحديد ما إذا كان التطبيق يعمل في بيئة التطوير أو الإنتاج
- تعيين عنوان API المناسب بناءً على البيئة
- توفير دالة `getApiUrl` التي تقوم بتحويل المسارات النسبية إلى مسارات مطلقة عند الحاجة

### 2. معالجة مسارات API

عند استخدام `apiRequest` أو عميل الاستعلام:

1. يتم فحص المسار لمعرفة ما إذا كان مطلقًا أو نسبيًا
2. إذا كان نسبيًا، يتم تحويله إلى المسار المناسب بناءً على البيئة
3. في بيئة الإنتاج، يتم استخدام عنوان API المطلق

### 3. وسائط إعادة التوجيه

في بيئة الإنتاج، تعمل وسائط إعادة التوجيه على:

- تصحيح مسارات API الواردة من الطلبات
- إعادة توجيه الطلبات إلى العنوان المناسب إذا لزم الأمر
- تجنب حلقات إعادة التوجيه عن طريق فحص المضيف

## استكشاف الأخطاء وإصلاحها

### مشكلة: طلبات API تفشل في بيئة الإنتاج

1. تأكد من أن متغير البيئة `API_URL` محدد بشكل صحيح
2. تحقق من أن الخادم الخلفي يعمل ويمكن الوصول إليه على العنوان المحدد
3. تحقق من سجلات الخطأ في مجلد `logs` للحصول على مزيد من المعلومات

### مشكلة: حلقات إعادة التوجيه

إذا واجهت حلقات إعادة توجيه (redirect loops):

1. تأكد من أن وسيط `apiRedirectMiddleware` يعمل بشكل صحيح
2. تحقق من أن فحص المضيف يعمل بشكل صحيح
3. قم بتعديل ملف `server/lib/api-redirect.ts` لتضمين مزيد من السجلات للتشخيص

## نشر التطبيق على Hostinger

عند نشر التطبيق على Hostinger:

1. قم بتشغيل سكريبت إعداد الإنتاج:
   ```bash
   node install/scripts/setup-prod-env.js
   ```

2. أدخل عنوان الاستضافة الخاص بك، مثل: `https://collider.online`

3. قم ببناء التطبيق للإنتاج:
   ```bash
   ./build-all.sh
   ```

4. انقل محتويات مجلد `build` إلى مجلد `public_html` في استضافة Hostinger

5. تأكد من أن ملف `.env` في مجلد الخادم يحتوي على متغير `API_URL` بالقيمة الصحيحة

لمزيد من المعلومات حول النشر على Hostinger، راجع [دليل النشر على Hostinger](../HOSTINGER-DEPLOYMENT-GUIDE.md).

---

**تاريخ التحديث:** مايو 2025