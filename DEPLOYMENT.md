# دليل النشر الشامل لنظام إصدار البطاقات والشهادات

## المحتويات

1. [متطلبات النظام](#متطلبات-النظام)
2. [الخيارات المتاحة للنشر](#الخيارات-المتاحة-للنشر)
3. [النشر باستخدام Docker](#النشر-باستخدام-docker)
4. [النشر المنفصل للواجهة الأمامية والخلفية](#النشر-المنفصل-للواجهة-الأمامية-والخلفية)
5. [إعداد قاعدة البيانات](#إعداد-قاعدة-البيانات)
6. [إدارة النسخ الاحتياطية](#إدارة-النسخ-الاحتياطية)
7. [استكشاف الأخطاء وإصلاحها](#استكشاف-الأخطاء-وإصلاحها)

## متطلبات النظام

لتشغيل نظام إصدار البطاقات والشهادات، تحتاج إلى:

- **Node.js**: الإصدار 18 أو أحدث
- **PostgreSQL**: الإصدار 14 أو أحدث
- **مساحة تخزين**: 1 غيغابايت على الأقل للملفات المرفوعة والصور المولدة
- **ذاكرة الوصول العشوائي (RAM)**: 1 غيغابايت على الأقل (يوصى بـ 2 غيغابايت أو أكثر)
- **وحدة المعالجة المركزية (CPU)**: نواة واحدة على الأقل (يوصى بنواتين أو أكثر)

## الخيارات المتاحة للنشر

يمكن نشر النظام بعدة طرق مختلفة، اعتماداً على احتياجاتك وبيئة التشغيل المتاحة:

1. **النشر باستخدام Docker**: الطريقة الأسهل والأكثر قابلية للنقل
2. **النشر المنفصل للواجهة الأمامية والخلفية**: للاستفادة من خدمات الاستضافة المتخصصة
3. **النشر باستخدام خدمات سحابية**: مثل AWS أو Google Cloud أو Azure

## النشر باستخدام Docker

### الخطوة 1: بناء صور Docker

```bash
./scripts/docker-build.sh
```

هذا السكريبت سيقوم بما يلي:
- بناء المشروع
- إنشاء صورة Docker للواجهة الأمامية
- إنشاء صورة Docker للواجهة الخلفية

### الخطوة 2: تشغيل النظام باستخدام Docker Compose

قبل تشغيل النظام، قم بتعديل ملف `docker-compose.yml` حسب احتياجاتك، وخاصةً:
- كلمة مرور قاعدة البيانات
- متغيرات البيئة مثل `SESSION_SECRET` و `ALLOWED_ORIGINS`

ثم قم بتشغيل النظام:

```bash
docker-compose up -d
```

### الخطوة 3: التحقق من عمل النظام

يمكنك التحقق من عمل النظام بالوصول إلى:
- الواجهة الأمامية: http://your-server-ip:3000
- نقطة فحص صحة النظام: http://your-server-ip:5000/health

## النشر المنفصل للواجهة الأمامية والخلفية

### نشر الواجهة الأمامية

#### على Netlify

1. قم ببناء الواجهة الأمامية:

```bash
cd client && npm run build
```

2. قم بتكوين متغيرات البيئة في لوحة تحكم Netlify:
   - `VITE_API_URL`: عنوان URL للواجهة الخلفية

3. قم برفع مجلد `client/dist` إلى Netlify

#### على Vercel

1. قم ببناء الواجهة الأمامية:

```bash
cd client && npm run build
```

2. قم بتكوين متغيرات البيئة في لوحة تحكم Vercel:
   - `VITE_API_URL`: عنوان URL للواجهة الخلفية

3. قم برفع مجلد `client/dist` إلى Vercel

### نشر الواجهة الخلفية

#### على VPS (خادم افتراضي خاص)

1. قم ببناء الواجهة الخلفية:

```bash
cd server && npm run build
```

2. قم بإنشاء ملف `.env` في مجلد `server/dist` وتكوين متغيرات البيئة:

```
PORT=5000
NODE_ENV=production
DATABASE_URL=postgresql://username:password@hostname:port/database
SESSION_SECRET=your-secure-session-key
ALLOWED_ORIGINS=https://your-frontend-domain.com
```

3. قم بتثبيت حزم Node.js:

```bash
cd server/dist && npm install --production
```

4. قم بتشغيل الخادم:

```bash
cd server/dist && node index.js
```

يوصى باستخدام مدير عمليات مثل PM2 لتشغيل الخادم:

```bash
npm install -g pm2
cd server/dist
pm2 start index.js --name certificates-api
```

## إعداد قاعدة البيانات

### إنشاء قاعدة البيانات

```bash
createdb certificates
```

### تطبيق مخطط قاعدة البيانات

```bash
npm run db:push
```

### ترحيل قاعدة البيانات

في حالة التحديث إلى إصدار جديد من النظام، قم بتنفيذ:

```bash
npm run db:push
```

## إدارة النسخ الاحتياطية

### إنشاء نسخة احتياطية

لإنشاء نسخة احتياطية من النظام:

```bash
./scripts/db-backup.sh
```

هذا السكريبت سيقوم بإنشاء نسخة احتياطية من:
- قاعدة البيانات
- الملفات المرفوعة

### استعادة نسخة احتياطية

لاستعادة قاعدة البيانات:

```bash
psql $DATABASE_URL < backups/db_backup_YYYY-MM-DD.sql
```

لاستعادة الملفات المرفوعة:

```bash
tar -xzf backups/uploads_backup_YYYY-MM-DD.tar.gz
```

## استكشاف الأخطاء وإصلاحها

### التحقق من صحة النظام

لفحص صحة جميع مكونات النظام:

```
GET /health
```

### مشاكل الاتصال بقاعدة البيانات

1. تأكد من أن متغير البيئة `DATABASE_URL` صحيح
2. تأكد من أن قاعدة البيانات تعمل وقابلة للوصول
3. تأكد من أن المستخدم لديه صلاحيات كافية

### مشاكل CORS

إذا ظهرت أخطاء CORS:

1. تأكد من تكوين `ALLOWED_ORIGINS` بشكل صحيح في الواجهة الخلفية
2. تأكد من أن `VITE_API_URL` مكون بشكل صحيح في الواجهة الأمامية
3. تأكد من أن الواجهة الخلفية تستجيب للطلبات مع رأس `Access-Control-Allow-Origin` المناسب

### مشاكل الإذن

صلاحيات الملفات:

```bash
chmod -R 755 uploads temp
```