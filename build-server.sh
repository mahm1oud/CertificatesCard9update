#!/bin/bash

# Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… (server)
# Ø§Ù„Ù†Ø³Ø®Ø© 2.0 - ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ù…Ø§ÙŠÙˆ 2025
#
# Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª:
# - Ø¯Ø¹Ù… ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù„Ø¥Ù†ØªØ§Ø¬ Ø£Ùˆ Ø§Ù„ØªØ·ÙˆÙŠØ±
# - ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª
# - ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
# - Ø¯Ø¹Ù… Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©
# - Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ®ØµÙŠØµ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø³Ø·Ø± Ø§Ù„Ø£ÙˆØ§Ù…Ø±
BUILD_MODE="production"
VERBOSE=0
CLEAN=1
COPY_ENV=1
MINIFY=1
LOG_FILE="server-build-log.txt"

# Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
show_help() {
  echo "Ø§Ø³ØªØ®Ø¯Ø§Ù…: ./build-server.sh [OPTIONS]"
  echo ""
  echo "Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:"
  echo "  -h, --help           Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"
  echo "  -d, --dev            Ø¨Ù†Ø§Ø¡ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ± (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø¥Ù†ØªØ§Ø¬)"
  echo "  -v, --verbose        ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙØµÙ„"
  echo "  --no-clean           Ø¹Ø¯Ù… Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡"
  echo "  --no-env             Ø¹Ø¯Ù… Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬"
  echo "  --no-minify          Ø¹Ø¯Ù… ØªØµØºÙŠØ± Ø§Ù„ÙƒÙˆØ¯"
  echo "  -l, --log FILE       Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: server-build-log.txt)"
  echo ""
  echo "Ù…Ø«Ø§Ù„: ./build-server.sh --dev --verbose"
  exit 0
}

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø³Ø·Ø± Ø§Ù„Ø£ÙˆØ§Ù…Ø±
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      ;;
    -d|--dev)
      BUILD_MODE="development"
      shift
      ;;
    -v|--verbose)
      VERBOSE=1
      shift
      ;;
    --no-clean)
      CLEAN=0
      shift
      ;;
    --no-env)
      COPY_ENV=0
      shift
      ;;
    --no-minify)
      MINIFY=0
      shift
      ;;
    -l|--log)
      LOG_FILE="$2"
      shift 2
      ;;
    *)
      echo "âŒ Ø®ÙŠØ§Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: $1"
      show_help
      ;;
  esac
done

# Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª
log() {
  local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
  echo "[$timestamp] $1"
  
  # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„ Ø£ÙŠØ¶Ù‹Ø§
  echo "[$timestamp] $1" >> "$LOG_FILE"
}

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªÙØ±ÙŠØºÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
echo "# Ø³Ø¬Ù„ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… - $(date)" > "$LOG_FILE"
echo "# ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù†Ø§Ø¡: $BUILD_MODE" >> "$LOG_FILE"
echo "----------------------------------------" >> "$LOG_FILE"

log "ğŸ› ï¸ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ ÙˆØ¶Ø¹ $BUILD_MODE..."

# ØªØµØ¯ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ø¨Ù†Ø§Ø¡
export NODE_ENV="$BUILD_MODE"

# Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ server
cd server || {
  log "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ server. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯."
  exit 1
}

# ØªÙ†Ø¸ÙŠÙ Ù…Ø¬Ù„Ø¯ dist Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§
if [ $CLEAN -eq 1 ]; then
  log "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ù…Ø¬Ù„Ø¯ dist..."
  rm -rf dist
  mkdir -p dist
else
  # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ dist Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
  mkdir -p dist
fi

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.installed" ]; then
  log "ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø§Ù„Ø®Ø§Ø¯Ù…..."
  npm install
  touch node_modules/.installed
fi

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
BUILD_OPTIONS="--platform=node --packages=external --bundle --outdir=dist"

# Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø§Ù„ØªØµØºÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§
if [ $MINIFY -eq 1 ]; then
  BUILD_OPTIONS="$BUILD_OPTIONS --minify"
fi

# Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± ØµÙŠØºØ© Ø§Ù„Ù…Ø®Ø±Ø¬ (ESM)
BUILD_OPTIONS="$BUILD_OPTIONS --format=esm"

# Ø¥Ø¶Ø§ÙØ© ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù†Ø§Ø¡
if [ "$BUILD_MODE" = "production" ]; then
  BUILD_OPTIONS="$BUILD_OPTIONS --define:process.env.NODE_ENV=\\\"production\\\""
else
  BUILD_OPTIONS="$BUILD_OPTIONS --define:process.env.NODE_ENV=\\\"development\\\""
fi

# ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡
log "âš™ï¸ ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… esbuild..."
log "Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡: $BUILD_OPTIONS"

if [ $VERBOSE -eq 1 ]; then
  # ÙˆØ¶Ø¹ Ù…ÙØµÙ„ - Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
  npx esbuild index.ts $BUILD_OPTIONS | tee -a "../$LOG_FILE"
  BUILD_RESULT=${PIPESTATUS[0]}
else
  # ÙˆØ¶Ø¹ ØµØ§Ù…Øª - Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·
  npx esbuild index.ts $BUILD_OPTIONS >> "../$LOG_FILE" 2>&1
  BUILD_RESULT=$?
fi

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡
if [ $BUILD_RESULT -eq 0 ]; then
  log "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ server/dist"
  
  # Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§
  log "ğŸ“„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©:"
  ls -la dist/ | tee -a "../$LOG_FILE"
  
  # ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
  TOTAL_SIZE=$(du -sh dist/ | cut -f1)
  log "ğŸ“Š Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©: $TOTAL_SIZE"
  
  # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†
  log "ğŸ“‹ Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©..."
  
  # Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§
  if [ $COPY_ENV -eq 1 ] && [ -f "../.env" ]; then
    cp "../.env" dist/
    log "âœ… ØªÙ… Ù†Ø³Ø® Ù…Ù„Ù .env"
  fi
  
  # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ´ØºÙŠÙ„
  for config_file in package.json tsconfig.json; do
    if [ -f "$config_file" ]; then
      cp "$config_file" dist/
      log "âœ… ØªÙ… Ù†Ø³Ø® Ù…Ù„Ù $config_file"
    fi
  done
  
  # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
  if [ -n "$OUTPUT_DIR" ]; then
    log "ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬: $OUTPUT_DIR"
    mkdir -p "../$OUTPUT_DIR/server"
    cp -r dist/* "../$OUTPUT_DIR/server/"
  fi
  
  # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù startup.sh Ù„ØªØ³Ù‡ÙŠÙ„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
  cat > dist/startup.sh << 'EOF'
#!/bin/bash
# Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
echo "ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…..."
node index.js
EOF
  chmod +x dist/startup.sh
  log "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„: startup.sh"
  
else
  log "âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„."
  
  # Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø³Ø¬Ù„
  if [ -f "../$LOG_FILE" ]; then
    log "Ø¢Ø®Ø± 10 Ø£Ø³Ø·Ø± Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡:"
    tail -n 10 "../$LOG_FILE"
  fi
  
  # Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø®Ø·Ø£
  cd ..
  exit 1
fi

# Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
cd ..

log "ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­."
log "ğŸ“ ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ: $LOG_FILE"
log "ğŸš€ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…: cd server/dist && ./startup.sh"