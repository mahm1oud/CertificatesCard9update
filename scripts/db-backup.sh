#!/bin/bash

# ูุต ุณูุฑูุจุช ุงููุณุฎ ุงูุงุญุชูุงุทู ููุงุนุฏุฉ ุงูุจูุงูุงุช
# ูุฐุง ุงูุณูุฑูุจุช ูููู ุจุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช
# ุงุณุชุฎุฏู: ./db-backup.sh [ุงุณู_ุงูููู_ุงูุงุฎุชูุงุฑู]

# ุชุนููู ุงููุชุบูุฑุงุช
BACKUP_DIR="./backups"
DATE=$(date +"%Y-%m-%d_%H-%M-%S")
FILENAME=${1:-"db_backup_$DATE.sql"}

# ุฅูุดุงุก ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุฅุฐุง ูู ููู ููุฌูุฏูุง
mkdir -p $BACKUP_DIR

# ุงูุชุญูู ูู ูุฌูุฏ ูุชุบูุฑ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    # ุงูุชุญูู ูู ูุฌูุฏ ูุชุบูุฑุงุช ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฑุฏูุฉ
    if [ -z "$PGHOST" ] || [ -z "$PGDATABASE" ] || [ -z "$PGUSER" ]; then
        echo "โ ุฎุทุฃ: ูุชุบูุฑ DATABASE_URL ุบูุฑ ููุฌูุฏ ููุชุบูุฑุงุช ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ููุชููุฉ."
        echo "ุงูุฑุฌุงุก ุชุนููู ุฅูุง DATABASE_URL ุฃู ุงููุชุบูุฑุงุช ุงููุฑุฏูุฉ (PGHOST, PGDATABASE, PGUSER, PGPASSWORD)."
        exit 1
    fi
    
    # ุงุณุชุฎุฏุงู ูุชุบูุฑุงุช ุงูุงุชุตุงู ุงููุฑุฏูุฉ
    echo "๐ ุงุณุชุฎุฏุงู ูุชุบูุฑุงุช ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฑุฏูุฉ..."
    
    # ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
    echo "๐ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช $PGDATABASE ุนูู ุงูุฎุงุฏู $PGHOST..."
    
    pg_dump -h $PGHOST -d $PGDATABASE -U $PGUSER -F c -f "$BACKUP_DIR/$FILENAME"
    
    # ุงูุชุญูู ูู ูุฌุงุญ ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู
    if [ $? -eq 0 ]; then
        echo "โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ ูู $BACKUP_DIR/$FILENAME"
        echo "๐ ุญุฌู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $(du -h "$BACKUP_DIR/$FILENAME" | cut -f1)"
    else
        echo "โ ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ."
        exit 1
    fi
else
    # ุงุณุชุฎุฏุงู ูุชุบูุฑ DATABASE_URL
    echo "๐ ุงุณุชุฎุฏุงู ูุชุบูุฑ DATABASE_URL..."
    
    # ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
    echo "๐ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช..."
    
    pg_dump "$DATABASE_URL" -F c -f "$BACKUP_DIR/$FILENAME"
    
    # ุงูุชุญูู ูู ูุฌุงุญ ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู
    if [ $? -eq 0 ]; then
        echo "โ ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ ูู $BACKUP_DIR/$FILENAME"
        echo "๐ ุญุฌู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $(du -h "$BACKUP_DIR/$FILENAME" | cut -f1)"
    else
        echo "โ ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ."
        exit 1
    fi
fi

# ุชูุธูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุฏููุฉ (ุงูุงุญุชูุงุธ ุจุขุฎุฑ 10 ูุณุฎ ููุท)
echo "๐งน ุชูุธูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุฏููุฉ..."
NUM_BACKUPS=$(ls -1 $BACKUP_DIR/db_backup_*.sql 2>/dev/null | wc -l)

if [ $NUM_BACKUPS -gt 10 ]; then
    ls -1t $BACKUP_DIR/db_backup_*.sql | tail -n +11 | xargs rm -f
    echo "๐๏ธ ุชู ุญุฐู $(($NUM_BACKUPS - 10)) ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุฏููุฉ."
else
    echo "โน๏ธ ุนุฏุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงูุญุงููุฉ: $NUM_BACKUPS (ูุง ุญุงุฌุฉ ููุชูุธูู)"
fi

echo "๐ ุชู ุงูุงูุชูุงุก ูู ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู."

# ุนุฑุถ ุชุนูููุงุช ุงูุงุณุชุนุงุฏุฉ
echo ""
echo "๐ ูุงุณุชุนุงุฏุฉ ูุฐู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ ุงุณุชุฎุฏู ุงูุฃูุฑ ุงูุชุงูู:"
echo "  pg_restore -h \$PGHOST -d \$PGDATABASE -U \$PGUSER -c -v \"$BACKUP_DIR/$FILENAME\""
echo "  ุฃู"
echo "  pg_restore -d \"\$DATABASE_URL\" -c -v \"$BACKUP_DIR/$FILENAME\""