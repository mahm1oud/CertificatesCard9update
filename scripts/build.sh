#!/bin/bash

# ุณูุฑูุจุช ุจูุงุก ุงููุดุฑูุน ูููุดุฑ
# ูุณุชุฎุฏู ูุฐุง ุงูุณูุฑูุจุช ูุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุงูุฎูููุฉ ูุฅุนุฏุงุฏ ุงููููุงุช ูููุดุฑ

echo "๐ง ุจุฏุก ุนูููุฉ ุงูุจูุงุก..."

# ุงูุชุญูู ูู ูุฌูุฏ ุงููุฌูุฏุงุช ุงููุดุชุฑูุฉ ููุฌูุฏ ุงูุชูุฒูุน
bash scripts/configure-assets.sh

# ุฅูุดุงุก ูุฌูุฏุงุช ุงูุชูุฒูุน ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
mkdir -p client/dist
mkdir -p server/dist

# ุงูุชุญูู ูู ูุฌูุฏ ูููุงุช ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุฅูุดุงุคูุง ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
bash scripts/create-env-files.sh

# ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
echo "๐จ ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (Frontend)..."
cd client

# ูุญุงููุฉ ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
npm run build 2>&1 | tee ../client-build-log.txt

# ุงูุชุญูู ูู ูุฌุงุญ ุนูููุฉ ุงูุจูุงุก
if [ ! -f "dist/index.html" ]; then
  echo "โ ูุดู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. ูุฑุฌู ุงูุชุญูู ูู ุณุฌู ุงูุจูุงุก ูู client-build-log.txt."
  exit 1
else
  echo "โ ุชู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจูุฌุงุญ."
fi

cd ..

# ุจูุงุก ุงููุงุฌูุฉ ุงูุฎูููุฉ
echo "๐จ ุจูุงุก ุงููุงุฌูุฉ ุงูุฎูููุฉ (Backend)..."
cd server

# ูุญุงููุฉ ุจูุงุก ุงููุงุฌูุฉ ุงูุฎูููุฉ
npm run build 2>&1 | tee ../server-build-log.txt

# ุงูุชุญูู ูู ูุฌุงุญ ุนูููุฉ ุงูุจูุงุก
if [ ! -f "dist/index.js" ]; then
  echo "โ ูุดู ุจูุงุก ุงููุงุฌูุฉ ุงูุฎูููุฉ. ูุฑุฌู ุงูุชุญูู ูู ุณุฌู ุงูุจูุงุก ูู server-build-log.txt."
  exit 1
else
  echo "โ ุชู ุจูุงุก ุงููุงุฌูุฉ ุงูุฎูููุฉ ุจูุฌุงุญ."
fi

cd ..

# ูุณุฎ ุงููุฌูุฏุงุช ุงููุดุชุฑูุฉ ุฅูู ูุฌูุฏ ุงูุชูุฒูุน ูููุงุฌูุฉ ุงูุฎูููุฉ
echo "๐ฆ ูุณุฎ ุงููุฌูุฏุงุช ุงููุดุชุฑูุฉ ุฅูู ูุฌูุฏ ุงูุชูุฒูุน ูููุงุฌูุฉ ุงูุฎูููุฉ..."
bash scripts/copy-assets.sh

# ูุณุฎ ูููุงุช ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุฅูุชุงุฌ
echo "๐ ูุณุฎ ูููุงุช ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุฅูุชุงุฌ..."
if [ -f "client/.env.production" ]; then
  cp client/.env.production client/dist/.env
  echo "โ ุชู ูุณุฎ ููู client/.env.production ุฅูู client/dist/.env."
else
  echo "โ๏ธ ููู client/.env.production ุบูุฑ ููุฌูุฏ. ูู ูุชู ูุณุฎ ููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุฅูุชุงุฌ ูููุงุฌูุฉ ุงูุฃูุงููุฉ."
fi

if [ -f "server/.env.production" ]; then
  cp server/.env.production server/dist/.env
  echo "โ ุชู ูุณุฎ ููู server/.env.production ุฅูู server/dist/.env."
else
  echo "โ๏ธ ููู server/.env.production ุบูุฑ ููุฌูุฏ. ูู ูุชู ูุณุฎ ููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุฅูุชุงุฌ ูููุงุฌูุฉ ุงูุฎูููุฉ."
fi

echo "๐ ุชูุช ุนูููุฉ ุงูุจูุงุก ุจูุฌุงุญ!"
echo "๐ ุงููููุงุช ุงููุงุชุฌุฉ:"
echo "  - ูุงุฌูุฉ ุฃูุงููุฉ: ./client/dist/"
echo "  - ูุงุฌูุฉ ุฎูููุฉ: ./server/dist/"
echo ""
echo "๐ ููุฒูุฏ ูู ุงููุนูููุงุช ุญูู ุงููุดุฑุ ุฑุงุฌุน ููู DEPLOY.md ุฃู README-DEPLOYMENT.md"