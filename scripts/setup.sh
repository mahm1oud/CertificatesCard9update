#!/bin/bash

# ุณูุฑูุจุช ุฅุนุฏุงุฏ ุงููุดุฑูุน
# ูุฐุง ุงูุณูุฑูุจุช ูููู ุจุฅุนุฏุงุฏ ุงูุจูุฆุฉ ุงููุงุฒูุฉ ูุชุดุบูู ุงููุดุฑูุน

# ุชุญูู ูู ูุฌูุฏ Node.js
echo "๐ ุงูุชุญูู ูู ูุฌูุฏ Node.js..."
if ! command -v node &> /dev/null; then
    echo "โ Node.js ุบูุฑ ูุซุจุช. ุงูุฑุฌุงุก ุชุซุจูุช Node.js (ุงูุฅุตุฏุงุฑ 18 ุฃู ุฃุญุฏุซ)"
    exit 1
fi

# ุชุญูู ูู ุฅุตุฏุงุฑ Node.js
NODE_VERSION=$(node -v | cut -d 'v' -f 2 | cut -d '.' -f 1)
if [ "$NODE_VERSION" -lt 18 ]; then
    echo "โ ุฅุตุฏุงุฑ Node.js ูุฏูู. ุงูุฑุฌุงุก ุชุซุจูุช Node.js ุงูุฅุตุฏุงุฑ 18 ุฃู ุฃุญุฏุซ"
    echo "ุงูุฅุตุฏุงุฑ ุงูุญุงูู: $(node -v)"
    exit 1
fi

echo "โ ุชู ุงูุชุญูู ูู Node.js: $(node -v)"

# ุฅูุดุงุก ููู .env ุฅุฐุง ูู ููู ููุฌูุฏุง
if [ ! -f ".env" ]; then
    echo "๐ ุฅูุดุงุก ููู .env ูู .env.example..."
    cp .env.example .env
    echo "โ ุชู ุฅูุดุงุก ููู .env"
else
    echo "๐ ููู .env ููุฌูุฏ ุจุงููุนู"
fi

# ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ
echo "๐ ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ..."
mkdir -p uploads temp fonts
echo "โ ุชู ุฅูุดุงุก ุงููุฌูุฏุงุช"

# ุชุซุจูุช ุงุนุชูุงุฏูุงุช ุงููุดุฑูุน
echo "๐ฆ ุชุซุจูุช ุงุนุชูุงุฏูุงุช ุงููุดุฑูุน..."
npm ci
echo "โ ุชู ุชุซุจูุช ุงุนุชูุงุฏูุงุช ุงููุดุฑูุน"

# ุงูุชุญูู ูู ูุฌูุฏ PostgreSQL
echo "๐ ุงูุชุญูู ูู ูุฌูุฏ PostgreSQL..."
if ! command -v psql &> /dev/null; then
    echo "โ๏ธ PostgreSQL ุบูุฑ ูุซุจุช. ุฅุฐุง ููุช ุชุฎุทุท ูุงุณุชุฎุฏุงู ูุงุนุฏุฉ ุจูุงูุงุช ูุญููุฉุ ุงูุฑุฌุงุก ุชุซุจูุช PostgreSQL"
    echo "ููููู ุฃูุถูุง ุงุณุชุฎุฏุงู Docker ููุญุตูู ุนูู ูุงุนุฏุฉ ุจูุงูุงุช PostgreSQL ุฏูู ุงูุญุงุฌุฉ ูุชุซุจูุชูุง ูุญูููุง"
else
    echo "โ ุชู ุงูุชุญูู ูู PostgreSQL: $(psql --version)"
fi

# ุงูุชุญูู ูู ูุฌูุฏ ูุชุบูุฑ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo "โ๏ธ ูุชุบูุฑ DATABASE_URL ุบูุฑ ููุฌูุฏ ูู ุงูุจูุฆุฉ"
    echo "ุงูุฑุฌุงุก ุชูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ููู .env"
else
    echo "โ ูุชุบูุฑ DATABASE_URL ููุฌูุฏ"
    
    # ูุญุงููุฉ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
    echo "๐ ูุญุงููุฉ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช..."
    if ! psql "$DATABASE_URL" -c '\conninfo' &> /dev/null; then
        echo "โ๏ธ ูุง ูููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุตุญุฉ ูุชุบูุฑ DATABASE_URL ูุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุฏ ุงูุชุดุบูู"
    else
        echo "โ ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ"
        
        # ุชุญุฏูุซ ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช
        echo "๐ ุชุญุฏูุซ ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
        npm run db:push
        echo "โ ุชู ุชุญุฏูุซ ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช"
    fi
fi

# ุฅุถุงูุฉ ุชูููุฐ ูุณูุฑูุจุชุงุช ุฅุถุงููุฉ
chmod +x scripts/*.sh

echo "๐ ุชู ุงูุงูุชูุงุก ูู ุงูุฅุนุฏุงุฏ ุจูุฌุงุญ!"
echo ""
echo "๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:"
echo "1. ุชุดุบูู ุงูุชุทุจูู ูู ูุถุน ุงูุชุทููุฑ: npm run dev"
echo "2. ุชุดุบูู ุงูุชุทุจูู ูู ูุถุน ุงูุฅูุชุงุฌ: npm run build && npm start"
echo "3. ุชุดุบูู ุงูุชุทุจูู ุจุงุณุชุฎุฏุงู Docker: docker-compose up -d"