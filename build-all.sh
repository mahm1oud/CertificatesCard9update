#!/bin/bash

# ุณูุฑูุจุช ุดุงูู ูุจูุงุก ูุชุฌููุน ุงููุดุฑูุน ูููุดุฑ
# ุงููุณุฎุฉ 2.0 - ุชุงุฑูุฎ ุงูุชุญุฏูุซ: ูุงูู 2025
#
# ุงูุชุญุณููุงุช:
# - ุฏุนู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
# - ุฅุถุงูุฉ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุญุณูุฉ
# - ุฏุนู ูุถุน ุงูุชุดุบูู ุงูุตุงูุช
# - ุงูุชูุงูู ูุน ูููุงุช ุงูุชุซุจูุช ูุงููุดุฑ
# - ูุญุต ุงููุชุทูุจุงุช ุงููุณุจูุฉ ูุจู ุงูุจุฏุก

# ูุนุงูุฌุฉ ุงูุฎูุงุฑุงุช ูู ุณุทุฑ ุงูุฃูุงูุฑ
SILENT_MODE=0
ENV_FILE=".env"
SKIP_CLIENT=0
SKIP_SERVER=0
SKIP_PACKAGE=0
OUTPUT_DIR="build"

# ุฏุงูุฉ ุนุฑุถ ุงููุณุงุนุฏุฉ
show_help() {
  echo "ุงุณุชุฎุฏุงู: ./build-all.sh [OPTIONS]"
  echo ""
  echo "ุงูุฎูุงุฑุงุช:"
  echo "  -h, --help            ุนุฑุถ ูุฐู ุงูุฑุณุงูุฉ ุงููุณุงุนุฏุฉ"
  echo "  -s, --silent          ูุถุน ุงูุชุดุบูู ุงูุตุงูุช (ุจุฏูู ูุทุงูุจุงุช)"
  echo "  -e, --env FILE        ุชุญุฏูุฏ ููู ุงูุจูุฆุฉ ุงููุณุชุฎุฏู (ุงูุงูุชุฑุงุถู: .env)"
  echo "  --skip-client         ุชุฎุทู ุจูุงุก ูุงุฌูุฉ ุงููุณุชุฎุฏู"
  echo "  --skip-server         ุชุฎุทู ุจูุงุก ุงูุฎุงุฏู"
  echo "  --skip-package        ุชุฎุทู ุชุฌููุน ุงููููุงุช ูููุดุฑ"
  echo "  -o, --output DIR      ูุฌูุฏ ุงูุฅุฎุฑุงุฌ ูููููุงุช ุงููุฌูุนุฉ (ุงูุงูุชุฑุงุถู: build)"
  echo ""
  echo "ูุซุงู: ./build-all.sh --env .env.production --output dist"
  exit 0
}

# ูุนุงูุฌุฉ ุฎูุงุฑุงุช ุณุทุฑ ุงูุฃูุงูุฑ
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      ;;
    -s|--silent)
      SILENT_MODE=1
      shift
      ;;
    -e|--env)
      ENV_FILE="$2"
      shift 2
      ;;
    --skip-client)
      SKIP_CLIENT=1
      shift
      ;;
    --skip-server)
      SKIP_SERVER=1
      shift
      ;;
    --skip-package)
      SKIP_PACKAGE=1
      shift
      ;;
    -o|--output)
      OUTPUT_DIR="$2"
      shift 2
      ;;
    *)
      echo "โ ุฎูุงุฑ ุบูุฑ ูุนุฑูู: $1"
      show_help
      ;;
  esac
done

# ุฏุงูุฉ ูุนุฑุถ ุฑุณุงุฆู ูุน ุงูููุช
log() {
  local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
  echo "[$timestamp] $1"
}

# ุฏุงูุฉ ุงูุชุฃููุฏ
confirm() {
  if [[ $SILENT_MODE -eq 1 ]]; then
    return 0
  fi
  
  read -p "$1 (y/n): " response
  case "$response" in
    [yY][eE][sS]|[yY]) 
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

# ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงููุณุจูุฉ
check_prerequisites() {
  log "๐ ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงููุณุจูุฉ..."
  
  # ุงูุชุญูู ูู ูุฌูุฏ Node.js
  if ! command -v node &> /dev/null; then
    log "โ Node.js ุบูุฑ ูุซุจุช. ุงูุฑุฌุงุก ุชุซุจูุชู ูุจู ุงููุชุงุจุนุฉ."
    exit 1
  fi
  
  # ุงูุชุญูู ูู ูุฌูุฏ npm
  if ! command -v npm &> /dev/null; then
    log "โ npm ุบูุฑ ูุซุจุช. ุงูุฑุฌุงุก ุชุซุจูุชู ูุจู ุงููุชุงุจุนุฉ."
    exit 1
  fi
  
  # ุงูุชุญูู ูู ูุฌูุฏ ุงูุณูุฑูุจุชุงุช ุงูุถุฑูุฑูุฉ
  if [[ $SKIP_CLIENT -eq 0 ]] && [[ ! -f "client/build-dist.sh" ]]; then
    log "โ ุณูุฑูุจุช ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุบูุฑ ููุฌูุฏ: client/build-dist.sh"
    exit 1
  fi
  
  if [[ $SKIP_SERVER -eq 0 ]] && [[ ! -f "server/build-dist.sh" ]]; then
    log "โ ุณูุฑูุจุช ุจูุงุก ุงูุฎุงุฏู ุบูุฑ ููุฌูุฏ: server/build-dist.sh"
    exit 1
  fi
  
  if [[ $SKIP_PACKAGE -eq 0 ]] && [[ ! -f "package-files.sh" ]]; then
    log "โ ุณูุฑูุจุช ุชุฌููุน ุงููููุงุช ุบูุฑ ููุฌูุฏ: package-files.sh"
    exit 1
  fi
  
  # ุงูุชุญูู ูู ูุฌูุฏ ููู ุงูุจูุฆุฉ
  if [[ ! -f "$ENV_FILE" ]] && [[ ! $SILENT_MODE -eq 1 ]]; then
    if confirm "โ๏ธ ููู ุงูุจูุฆุฉ ($ENV_FILE) ุบูุฑ ููุฌูุฏ. ูู ุชุฑุบุจ ูู ุฅูุดุงุฆู ูู ุงููุงูุจ?"; then
      # ุงุณุชูุฑุงุฏ ุณูุฑูุจุช ุฅูุดุงุก ููู ุงูุจูุฆุฉ
      if [[ -f "install/scripts/install.js" ]]; then
        log "๐ ุฌุงุฑู ุฅูุดุงุก ููู ุงูุจูุฆุฉ ูู ุงููุงูุจ..."
        node install/scripts/install.js --env-only
      else
        # ูุณุฎ ุงููุงูุจ ูุจุงุดุฑุฉ ุฅุฐุง ูุงู ููุฌูุฏุงู
        if [[ -f "install/config/env.template" ]]; then
          cp install/config/env.template "$ENV_FILE"
          log "โ ุชู ุฅูุดุงุก ููู ุงูุจูุฆุฉ ูู ุงููุงูุจ: $ENV_FILE"
        else
          log "โ ูุงูุจ ููู ุงูุจูุฆุฉ ุบูุฑ ููุฌูุฏ. ุงูุฑุฌุงุก ุฅูุดุงุก ููู $ENV_FILE ูุฏููุงู."
          exit 1
        fi
      fi
    fi
  fi
  
  log "โ ุชู ุงูุชุญูู ูู ุฌููุน ุงููุชุทูุจุงุช ุงููุณุจูุฉ ุจูุฌุงุญ."
}

# ุชูุญูุฏ ุงููุฌูุฏุงุช ุงููููุฉ
create_directories() {
  log "๐ ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุงุฒูุฉ..."
  
  # ุงููุฌูุฏุงุช ุงููุงุฒูุฉ ููุชุทุจูู
  mkdir -p logs uploads temp fonts
  
  # ูุฌูุฏ ุงูุฅุฎุฑุงุฌ ุงูููุงุฆู
  mkdir -p "$OUTPUT_DIR"
  
  log "โ ุชู ุฅูุดุงุก ุฌููุน ุงููุฌูุฏุงุช ุงููุงุฒูุฉ."
}

# ุชูููุฐ ุตูุงุญูุงุช ุงูุชูููุฐ ููุณูุฑูุจุชุงุช
setup_permissions() {
  log "๐ ุฅุนุฏุงุฏ ุตูุงุญูุงุช ุงูุชูููุฐ ููุณูุฑูุจุชุงุช..."
  
  chmod +x client/build-dist.sh server/build-dist.sh package-files.sh
  
  # ุฅุนุทุงุก ุตูุงุญูุงุช ุงูุชูููุฐ ุฃูุถูุง ูุณูุฑูุจุชุงุช ุงูุชุซุจูุช ูุงููุดุฑ
  if [[ -d "install/scripts" ]]; then
    find install/scripts -name "*.sh" -exec chmod +x {} \;
    log "โ ุชู ุฅุนุฏุงุฏ ุตูุงุญูุงุช ุงูุชูููุฐ ูุณูุฑูุจุชุงุช ุงูุชุซุจูุช ูุงููุดุฑ."
  fi
  
  log "โ ุชู ุฅุนุฏุงุฏ ุตูุงุญูุงุช ุงูุชูููุฐ ููุณูุฑูุจุชุงุช."
}

# ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
build_client() {
  if [[ $SKIP_CLIENT -eq 1 ]]; then
    log "โฉ ุชู ุชุฎุทู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจูุงุกู ุนูู ุงูุฎูุงุฑุงุช."
    return 0
  fi
  
  log "๐น ุฎุทูุฉ 1: ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ"
  cd client
  ./build-dist.sh
  local client_build_result=$?
  cd ..
  
  # ุงูุชุญูู ูู ูุฌุงุญ ุจูุงุก ุงููุงุฌูุฉ
  if [[ $client_build_result -ne 0 ]] || [[ ! -d "client/dist" ]]; then
    log "โ ูุดู ูู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ."
    
    if [[ $SILENT_MODE -eq 0 ]] && confirm "ูู ุชุฑุบุจ ูู ูุญุงููุฉ ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุงุณุชุฎุฏุงู build-client.sh?"; then
      ./build-client.sh
      if [[ $? -ne 0 ]]; then
        log "โ ูุดู ูู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุฑุฉ ุฃุฎุฑู."
        if [[ $SILENT_MODE -eq 0 ]] && ! confirm "ูู ุชุฑุบุจ ูู ุงููุชุงุจุนุฉ ุนูู ุงูุฑุบู ูู ูุดู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ?"; then
          exit 1
        fi
      else
        log "โ ุชู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจูุฌุงุญ ูู ุงููุญุงููุฉ ุงูุซุงููุฉ."
      fi
    elif [[ $SILENT_MODE -eq 1 ]]; then
      log "โ๏ธ ูุดู ูู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. ุงููุชุงุจุนุฉ ูู ุงููุถุน ุงูุตุงูุช."
    else
      exit 1
    fi
  else
    log "โ ุชู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจูุฌุงุญ."
  fi
}

# ุจูุงุก ุงูุฎุงุฏู
build_server() {
  if [[ $SKIP_SERVER -eq 1 ]]; then
    log "โฉ ุชู ุชุฎุทู ุจูุงุก ุงูุฎุงุฏู ุจูุงุกู ุนูู ุงูุฎูุงุฑุงุช."
    return 0
  fi
  
  log "๐น ุฎุทูุฉ 2: ุจูุงุก ุงูุฎุงุฏู"
  cd server
  ./build-dist.sh
  local server_build_result=$?
  cd ..
  
  # ุงูุชุญูู ูู ูุฌุงุญ ุจูุงุก ุงูุฎุงุฏู
  if [[ $server_build_result -ne 0 ]] || [[ ! -d "server/dist" ]]; then
    log "โ ูุดู ูู ุจูุงุก ุงูุฎุงุฏู."
    
    if [[ $SILENT_MODE -eq 0 ]] && confirm "ูู ุชุฑุบุจ ูู ูุญุงููุฉ ุจูุงุก ุงูุฎุงุฏู ูุฑุฉ ุฃุฎุฑู ุจุงุณุชุฎุฏุงู build-server.sh?"; then
      ./build-server.sh
      if [[ $? -ne 0 ]]; then
        log "โ ูุดู ูู ุจูุงุก ุงูุฎุงุฏู ูุฑุฉ ุฃุฎุฑู."
        if [[ $SILENT_MODE -eq 0 ]] && ! confirm "ูู ุชุฑุบุจ ูู ุงููุชุงุจุนุฉ ุนูู ุงูุฑุบู ูู ูุดู ุจูุงุก ุงูุฎุงุฏู?"; then
          exit 1
        fi
      else
        log "โ ุชู ุจูุงุก ุงูุฎุงุฏู ุจูุฌุงุญ ูู ุงููุญุงููุฉ ุงูุซุงููุฉ."
      fi
    elif [[ $SILENT_MODE -eq 1 ]]; then
      log "โ๏ธ ูุดู ูู ุจูุงุก ุงูุฎุงุฏู. ุงููุชุงุจุนุฉ ูู ุงููุถุน ุงูุตุงูุช."
    else
      exit 1
    fi
  else
    log "โ ุชู ุจูุงุก ุงูุฎุงุฏู ุจูุฌุงุญ."
  fi
}

# ุชุฌููุน ุงููููุงุช ูููุดุฑ
package_files() {
  if [[ $SKIP_PACKAGE -eq 1 ]]; then
    log "โฉ ุชู ุชุฎุทู ุชุฌููุน ุงููููุงุช ูููุดุฑ ุจูุงุกู ุนูู ุงูุฎูุงุฑุงุช."
    return 0
  fi
  
  log "๐น ุฎุทูุฉ 3: ุชุฌููุน ุงููููุงุช ูููุดุฑ ูู $OUTPUT_DIR"
  
  # ุชุนุฏูู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ูุณูุฑูุจุช ุงูุชุฌููุน
  export OUTPUT_DIR="$OUTPUT_DIR"
  
  ./package-files.sh
  
  if [[ $? -ne 0 ]]; then
    log "โ ูุดู ูู ุชุฌููุน ุงููููุงุช ูููุดุฑ."
    if [[ $SILENT_MODE -eq 0 ]] && ! confirm "ูู ุชุฑุบุจ ูู ุงููุชุงุจุนุฉ ุนูู ุงูุฑุบู ูู ูุดู ุชุฌููุน ุงููููุงุช?"; then
      exit 1
    fi
  else
    log "โ ุชู ุชุฌููุน ุงููููุงุช ูููุดุฑ ุจูุฌุงุญ."
  fi
}

# ูุณุฎ ูููุงุช ุงูุชุซุจูุช
copy_install_files() {
  log "๐น ุฎุทูุฉ 4: ูุณุฎ ูููุงุช ุงูุชุซุจูุช ูุงูุฅุฑุดุงุฏุงุช"
  
  # ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุฌูุฏ ุงูุฅุฎุฑุงุฌ
  mkdir -p "$OUTPUT_DIR/install"
  
  # ูุณุฎ ูููุงุช ุงูุชุซุจูุช
  if [[ -d "install" ]]; then
    cp -r install/* "$OUTPUT_DIR/install/"
    log "โ ุชู ูุณุฎ ูููุงุช ุงูุชุซุจูุช."
  else
    log "โ๏ธ ูุฌูุฏ ุงูุชุซุจูุช ุบูุฑ ููุฌูุฏ. ุชุฎุทู ูุณุฎ ูููุงุช ุงูุชุซุจูุช."
  fi
  
  # ูุณุฎ ูููุงุช ุงูุฅุฑุดุงุฏุงุช
  for doc_file in README.md HOSTINGER-DEPLOYMENT-GUIDE.md MYSQL-MIGRATION-GUIDE.md TROUBLESHOOTING-GUIDE.md DEVELOPER-GUIDE.md; do
    if [[ -f "$doc_file" ]]; then
      cp "$doc_file" "$OUTPUT_DIR/"
      log "โ ุชู ูุณุฎ ููู ุงูุฅุฑุดุงุฏุงุช: $doc_file"
    fi
  done
  
  # ูุณุฎ ููู ุงูุจูุฆุฉ ุงููููุฐุฌู ูุงูุณูุฑูุจุชุงุช
  if [[ -f "install/config/env.template" ]]; then
    cp "install/config/env.template" "$OUTPUT_DIR/"
    log "โ ุชู ูุณุฎ ููู ุงูุจูุฆุฉ ุงููููุฐุฌู."
  fi
  
  # ูุณุฎ ุณูุฑูุจุชุงุช ุงูุจูุงุก
  for script_file in build-all.sh build-client.sh build-server.sh package-files.sh; do
    if [[ -f "$script_file" ]]; then
      cp "$script_file" "$OUTPUT_DIR/"
      chmod +x "$OUTPUT_DIR/$script_file"
      log "โ ุชู ูุณุฎ ุณูุฑูุจุช: $script_file"
    fi
  done
}

# ุงููุธููุฉ ุงูุฑุฆูุณูุฉ
main() {
  log "๐ ุจุฏุก ุนูููุฉ ุงูุจูุงุก ุงูุดุงููุฉ..."
  
  # ุงูุชุญูู ูู ุงููุชุทูุจุงุช ุงููุณุจูุฉ
  check_prerequisites
  
  # ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุงุฒูุฉ
  create_directories
  
  # ุฅุนุฏุงุฏ ุตูุงุญูุงุช ุงูุชูููุฐ
  setup_permissions
  
  # ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
  build_client
  
  # ุจูุงุก ุงูุฎุงุฏู
  build_server
  
  # ุชุฌููุน ุงููููุงุช ูููุดุฑ
  package_files
  
  # ูุณุฎ ูููุงุช ุงูุชุซุจูุช ูุงูุฅุฑุดุงุฏุงุช
  copy_install_files
  
  log "๐ ุชูุช ุนูููุฉ ุงูุจูุงุก ุงูุดุงููุฉ ุจูุฌุงุญ!"
  log "โน๏ธ ุงููููุงุช ุฌุงูุฒุฉ ูููุดุฑ ูู ูุฌูุฏ $OUTPUT_DIR"
  log "๐ ููุดุฑ ุงูุชุทุจููุ ูู ุจููู ูุญุชููุงุช ูุฌูุฏ $OUTPUT_DIR ุฅูู ูุฌูุฏ public_html ูู ุงุณุชุถุงูุชู"
  log "๐ ููุฒูุฏ ูู ุงููุนูููุงุช ุญูู ุงููุดุฑุ ุฑุงุฌุน HOSTINGER-DEPLOYMENT-GUIDE.md"
}

# ุชูููุฐ ุงูุจุฑูุงูุฌ ุงูุฑุฆูุณู
main