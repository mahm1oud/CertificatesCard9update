#!/bin/bash

# ุณูุฑูุจุช ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (client)
# ุงููุณุฎุฉ 2.0 - ุชุงุฑูุฎ ุงูุชุญุฏูุซ: ูุงูู 2025
#
# ุงูุชุญุณููุงุช:
# - ุฏุนู ูุถุน ุงูุจูุงุก ููุฅูุชุงุฌ ุฃู ุงูุชุทููุฑ
# - ุชุญุณูู ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ูุงูุณุฌูุงุช
# - ุชูุธูู ุงููููุงุช ุงููุฏููุฉ ูุจู ุงูุจูุงุก
# - ุฎูุงุฑุงุช ุฅุถุงููุฉ ูุชุฎุตูุต ุนูููุฉ ุงูุจูุงุก

# ูุนุงูุฌุฉ ุงูุฎูุงุฑุงุช ูู ุณุทุฑ ุงูุฃูุงูุฑ
BUILD_MODE="production"
VERBOSE=0
CLEAN=1
LOG_FILE="client-build-log.txt"

# ุฏุงูุฉ ุนุฑุถ ุงููุณุงุนุฏุฉ
show_help() {
  echo "ุงุณุชุฎุฏุงู: ./build-client.sh [OPTIONS]"
  echo ""
  echo "ุงูุฎูุงุฑุงุช:"
  echo "  -h, --help           ุนุฑุถ ูุฐู ุงูุฑุณุงูุฉ ุงููุณุงุนุฏุฉ"
  echo "  -d, --dev            ุจูุงุก ูู ูุถุน ุงูุชุทููุฑ (ุงูุงูุชุฑุงุถู: ุงูุฅูุชุงุฌ)"
  echo "  -v, --verbose        ูุถุน ุงูุชุณุฌูู ุงูููุตู"
  echo "  --no-clean           ุนุฏู ุญุฐู ุงููููุงุช ุงูุณุงุจูุฉ ูุจู ุงูุจูุงุก"
  echo "  -l, --log FILE       ููู ุงูุณุฌู ุงููุณุชุฎุฏู (ุงูุงูุชุฑุงุถู: client-build-log.txt)"
  echo ""
  echo "ูุซุงู: ./build-client.sh --dev --verbose"
  exit 0
}

# ูุนุงูุฌุฉ ุฎูุงุฑุงุช ุณุทุฑ ุงูุฃูุงูุฑ
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      ;;
    -d|--dev)
      BUILD_MODE="development"
      shift
      ;;
    -v|--verbose)
      VERBOSE=1
      shift
      ;;
    --no-clean)
      CLEAN=0
      shift
      ;;
    -l|--log)
      LOG_FILE="$2"
      shift 2
      ;;
    *)
      echo "โ ุฎูุงุฑ ุบูุฑ ูุนุฑูู: $1"
      show_help
      ;;
  esac
done

# ุฏุงูุฉ ูุนุฑุถ ุฑุณุงุฆู ูุน ุงูููุช
log() {
  local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
  echo "[$timestamp] $1"
  
  # ุฅุถุงูุฉ ุงูุณุฌู ุฅูู ููู ุงูุณุฌู ุฃูุถูุง
  echo "[$timestamp] $1" >> "$LOG_FILE"
}

# ุฅูุดุงุก ููู ุณุฌู ุฌุฏูุฏ ุฃู ุชูุฑูุบู ุฅุฐุง ูุงู ููุฌูุฏูุง
echo "# ุณุฌู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ - $(date)" > "$LOG_FILE"
echo "# ูุถุน ุงูุจูุงุก: $BUILD_MODE" >> "$LOG_FILE"
echo "----------------------------------------" >> "$LOG_FILE"

log "๐๏ธ ุจุฏุก ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูู ูุถุน $BUILD_MODE..."

# ุชุตุฏูุฑ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุจูุงุก
export NODE_ENV="$BUILD_MODE"

# ุงูุงูุชูุงู ุฅูู ูุฌูุฏ client
cd client || {
  log "โ ูุดู ูู ุงูุงูุชูุงู ุฅูู ูุฌูุฏ client. ุชุฃูุฏ ูู ูุฌูุฏ ุงููุฌูุฏ."
  exit 1
}

# ุชูุธูู ูุฌูุฏ dist ุฅุฐุง ูุงู ูุทููุจูุง
if [ $CLEAN -eq 1 ]; then
  log "๐งน ุชูุธูู ูุฌูุฏ dist..."
  rm -rf dist
  mkdir -p dist
else
  # ุฅูุดุงุก ูุฌูุฏ dist ุฅุฐุง ูู ููู ููุฌูุฏุงู
  mkdir -p dist
fi

# ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.installed" ]; then
  log "๐ฆ ุชุซุจูุช ุงุนุชูุงุฏูุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ..."
  npm install
  touch node_modules/.installed
fi

# ุชูููุฐ ุฃูุฑ ุงูุจูุงุก
log "โ๏ธ ุชูููุฐ ุฃูุฑ ุงูุจูุงุก..."

if [ $VERBOSE -eq 1 ]; then
  # ูุถุน ููุตู - ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช
  npx vite build | tee -a "../$LOG_FILE"
  BUILD_RESULT=${PIPESTATUS[0]}
else
  # ูุถุน ุตุงูุช - ุญูุธ ุงูุณุฌูุงุช ูู ุงูููู ููุท
  npx vite build >> "../$LOG_FILE" 2>&1
  BUILD_RESULT=$?
fi

# ุงูุชุญูู ูู ูุฌุงุญ ุนูููุฉ ุงูุจูุงุก
if [ $BUILD_RESULT -eq 0 ]; then
  log "โ ุชู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจูุฌุงุญ! ุงููููุงุช ููุฌูุฏุฉ ูู client/dist"
  
  # ุนุฑุถ ูุงุฆูุฉ ุงููููุงุช ุงูุชู ุชู ุฅูุดุงุคูุง
  log "๐ ูุงุฆูุฉ ุงููููุงุช ุงูููุดุฃุฉ:"
  ls -la dist/ | tee -a "../$LOG_FILE"
  
  # ุชุญูู ูู ุญุฌู ุงููููุงุช
  TOTAL_SIZE=$(du -sh dist/ | cut -f1)
  log "๐ ุงูุญุฌู ุงูุฅุฌูุงูู ูููููุงุช ุงูููุดุฃุฉ: $TOTAL_SIZE"
  
  # ูุณุฎ ูููุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุฅูู ูุฌูุฏ ุงูุฅุฎุฑุงุฌ ุฅุฐุง ุชู ุชุญุฏูุฏู
  if [ -n "$OUTPUT_DIR" ]; then
    log "๐ ูุณุฎ ุงููููุงุช ุฅูู ูุฌูุฏ ุงูุฅุฎุฑุงุฌ: $OUTPUT_DIR"
    mkdir -p "../$OUTPUT_DIR/client"
    cp -r dist/* "../$OUTPUT_DIR/client/"
  fi
else
  log "โ ูุดู ูู ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. ุชุญูู ูู ุณุฌู ุงูุจูุงุก ููุญุตูู ุนูู ุงููุฒูุฏ ูู ุงูุชูุงุตูู."
  
  # ุนุฑุถ ุงูุฃุฎุทุงุก ูู ููู ุงูุณุฌู
  if [ -f "../$LOG_FILE" ]; then
    log "ุขุฎุฑ 10 ุฃุณุทุฑ ูู ุณุฌู ุงูุจูุงุก:"
    tail -n 10 "../$LOG_FILE"
  fi
  
  # ุงูุนูุฏุฉ ุฅูู ุงููุฌูุฏ ุงูุฑุฆูุณู ูุงูุฎุฑูุฌ ุจุฎุทุฃ
  cd ..
  exit 1
fi

# ุชูููุฏ ููู ุฅุญุตุงุฆูุงุช ุงูุญุฒูุฉ ุฅุฐุง ูุงู ูู ูุถุน ุงูุฅูุชุงุฌ
if [ "$BUILD_MODE" = "production" ]; then
  log "๐ ุชูููุฏ ุชูุฑูุฑ ุฅุญุตุงุฆูุงุช ุงูุญุฒูุฉ..."
  if command -v npx &> /dev/null; then
    npx vite-bundle-analyzer dist/stats.html >> "../$LOG_FILE" 2>&1 || log "โ๏ธ ูู ูููู ุชูููุฏ ุชูุฑูุฑ ุฅุญุตุงุฆูุงุช ุงูุญุฒูุฉ."
  fi
fi

# ุงูุนูุฏุฉ ุฅูู ุงููุฌูุฏ ุงูุฑุฆูุณู
cd ..

log "๐ ุงูุชููุช ุนูููุฉ ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุจูุฌุงุญ."
log "๐ ุชู ุญูุธ ุณุฌู ุงูุจูุงุก ุงููุงูู ูู: $LOG_FILE"